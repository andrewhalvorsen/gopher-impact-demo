<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smokin’ Burrow – Gopher Impact Estimator (1-Year)</title>
<style>
  :root{
    --yellow:#f4cf2f;
    --ink:#111827;
    --muted:#6b7280;
    --bg:#f9fafb;
    --card:#ffffff;
    --accent:#111827;
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{
    max-width:1100px; margin:48px auto; padding:0 16px;
    display:grid; grid-template-columns: 420px 1fr; gap:24px;
  }
  .panel{
    border-radius:var(--radius); box-shadow:0 10px 25px rgba(0,0,0,.06);
  }
  .left{
    background:var(--yellow); padding:28px 22px;
    display:flex; flex-direction:column; gap:22px;
  }
  .right{
    background:var(--card); padding:28px 24px;
  }

  h1{margin:0 0 8px; font-size:22px; line-height:1.25;}
  .sub{color:var(--ink); opacity:.8; font-size:14px;}

  /* Control group */
  .group{display:flex; flex-direction:column; gap:10px;}
  .label{font-weight:600; font-size:14px;}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .segmented{
    display:flex; background:rgba(255,255,255,.35); padding:4px; border-radius:999px;
  }
  .segmented button{
    appearance:none; border:0; background:transparent; padding:8px 14px; border-radius:999px;
    font-weight:600; cursor:pointer;
  }
  .segmented button.active{ background:#fff; color:var(--ink); }

  /* Slider */
  .slider-wrap{position:relative; padding-top:6px;}
  input[type="range"]{
    -webkit-appearance:none; width:100%; height:6px; border-radius:999px;
    background: rgba(255,255,255,.5); outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%;
    background:#fff; border:2px solid rgba(0,0,0,.1); cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{
    width:22px; height:22px; border:none; border-radius:50%;
    background:#fff; cursor:pointer;
  }
  .bubble{
    position:absolute; top:-26px; transform:translateX(-50%);
    background:#fff; padding:4px 8px; font-size:12px; border-radius:8px; box-shadow:0 6px 14px rgba(0,0,0,.12);
    white-space:nowrap;
  }

  /* Toggles */
  .switch{
    display:flex; align-items:center; gap:10px; font-weight:600;
  }
  .switch input{ display:none; }
  .toggle{
    width:46px; height:28px; border-radius:999px; background:rgba(0,0,0,.25); position:relative; cursor:pointer;
  }
  .toggle::after{
    content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#fff;
    transition:transform .18s ease;
  }
  .switch input:checked + .toggle{ background:#16a34a;}
  .switch input:checked + .toggle::after{ transform:translateX(18px); }

  /* Right panel content */
  .headerline{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px;}
  .title{font-size:18px; font-weight:700;}
  .compare{
    display:flex; align-items:center; gap:8px; font-weight:600; color:var(--muted);
    user-select:none; cursor:pointer;
  }
  .compare input{ accent-color:#111827; }

  .metric{
    margin:18px 0 12px; display:flex; align-items:baseline; gap:10px;
  }
  .num{
    font-size:34px; font-weight:800; letter-spacing:-0.02em;
  }
  .badge{
    padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; font-weight:700; color:#374151;
  }

  .grid{
    display:grid; grid-template-columns: 1fr 1fr; gap:16px;
  }
  .card{
    border:1px solid #e5e7eb; border-radius:14px; padding:16px;
  }
  .card h3{ margin:0 0 10px; font-size:14px; text-transform:uppercase; letter-spacing:.06em; color:#6b7280; }
  .tbl{ width:100%; border-collapse:collapse; }
  .tbl td{ padding:8px 0; border-bottom:1px dashed #e5e7eb; font-size:14px; }
  .tbl td:last-child{ text-align:right; font-variant-numeric: tabular-nums; }
  .tbl tr:last-child td{ border-bottom:none; font-weight:700; }

  .foot{
    margin-top:18px; color:#6b7280; font-size:12px;
  }

  @media (max-width:980px){
    .wrap{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT / CONTROLS -->
    <section class="panel left" aria-label="Controls">
      <div>
        <h1>See how much rodents cost you</h1>
        <div class="sub">Adjust infestation level and acres. Results update instantly.</div>
      </div>

      <!-- Infestation Level: 3-stop slider -->
      <div class="group" id="infestationGroup">
        <div class="label">Infestation Level</div>
        <div class="segmented" role="tablist" aria-label="Infestation Level">
          <button type="button" class="infbtn" data-level="1" role="tab" aria-selected="false">Mild</button>
          <button type="button" class="infbtn active" data-level="2" role="tab" aria-selected="true">Medium</button>
          <button type="button" class="infbtn" data-level="3" role="tab" aria-selected="false">Severe</button>
        </div>
      </div>

      <!-- Acres slider 10–80 with bubble -->
      <div class="group">
        <div class="label">Acres</div>
        <div class="slider-wrap">
          <div class="bubble" id="acreBubble">40 acres</div>
          <input id="acres" type="range" min="10" max="80" step="1" value="40" aria-label="Acres" />
        </div>
      </div>

      <!-- Owl Boxes switch -->
      <div class="group">
        <label class="switch">
          <input id="owls" type="checkbox" aria-label="Owl Boxes" />
          <span class="toggle" aria-hidden="true"></span>
          <span>Owl Boxes</span>
        </label>
      </div>
    </section>

    <!-- RIGHT / RESULTS -->
    <section class="panel right" aria-live="polite" aria-atomic="true">
      <div class="headerline">
        <div class="title">1-Year Impact (Almonds)</div>
        <label class="compare"><input id="compare" type="checkbox" /> Compare Treated</label>
      </div>

      <!-- Natural (default visible) & Treated (toggle) -->
      <div class="grid">
        <div class="card" id="naturalCard">
          <h3>Natural</h3>
          <div class="metric">
            <div class="num" id="natTotal">$—</div>
            <span class="badge">Total Damage (1 year)</span>
          </div>
          <table class="tbl" aria-label="Natural damage breakdown">
            <tbody id="natBreak"></tbody>
          </table>
          <div class="foot">Population after 1 year: <strong id="natPerAcre">—</strong> per acre</div>
        </div>

        <div class="card" id="treatedCard" style="display:none;">
          <h3>Treated</h3>
          <div class="metric">
            <div class="num" id="trtTotal">$—</div>
            <span class="badge">Total Damage (1 year)</span>
          </div>
          <table class="tbl" aria-label="Treated damage breakdown">
            <tbody id="trtBreak"></tbody>
          </table>
          <div class="foot">Population after 1 year: <strong id="trtPerAcre">—</strong> per acre</div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ------------------------------ Model (deterministic) ------------------------------ */
/* Ported from your C++ constants. One-year projection only. */
const Model = (() => {
  // ---- Horizon ----
  const YEARS = 1; // show Year 0 -> Year 1

  // ---- Owl density ----
  const owlsPer100Acres = 1.9;

  // ---- Ecology (gophers, irrigated almonds) ----
  const K_per_acre = 80.0;
  const litterMean = 6.0;       // deterministic: use mean, no noise
  const birthFracFemale = 0.70;
  const breederFrac = 0.80;
  const fertSlope  = 3.5;

  // Annual survival (deterministic at means)
  const survJ = 0.45;
  const survS = 0.65;
  const survA = 0.82;

  // Adult aging
  const agingA = 0.08;

  // Treatment: CO2 (25% kill/pass, 6 passes/year)
  const passesPerYear = 6;
  const killRatePerPass = 0.25;
  const surviveAnnual = Math.pow(1.0 - killRatePerPass, passesPerYear); // (0.75)^6

  // ---- Almond economics ----
  const pricePerLb = 2.50;
  const yieldLbPerAcre = 2500.0;
  const lossMild = 0.02, lossMedium = 0.04, lossSevere = 0.06;
  const lossAfterTreat = 0.01;

  // Damage baselines per acre
  const dripPerAcre_base = 60.0;
  const cropDmgPerAcre_base = 40.0;
  const otherPerAcre_base = 70.0;

  // Severity multipliers (Natural only)
  const sevMultMild = 0.8, sevMultMed = 1.0, sevMultSev = 1.2;

  // After treatment, non-yield damages are 20% of baseline
  const maintMultiplierAfterTreat = 0.20;

  function basePer10(level){
    return level===1?20.0:(level===2?40.0:70.0);
  }
  function severityName(level){
    return level===1? "Small" : (level===2? "Medium" : "Large");
  }
  function sevMult(level){
    return level===1? sevMultMild : (level===2? sevMultMed : sevMultSev);
  }
  function lossRate(level){
    return level===1? lossMild : (level===2? lossMedium : lossSevere);
  }

  // One deterministic annual step
  function annualStep(P, acres, owlsOn){
    // P = [[Jf,Jm],[Sf,Sm],[Af,Am]]
    let [Jf,Jm,Sf,Sm,Af,Am] = [P[0][0],P[0][1],P[1][0],P[1][1],P[2][0],P[2][1]];

    const K_total = K_per_acre * acres;
    const total = Jf+Jm+Sf+Sm+Af+Am;
    const density = K_total>0 ? (total / K_total) : 0.0;

    // Density-dependent fertility (logistic taper)
    const fertMult = 1.0 / (1.0 + Math.exp(fertSlope * (density - 1.0)));

    // Reproduction (deterministic litter = mean, clamped in C++ 5..6.5, but mean=6 is within)
    const litter = litterMean;
    const breeders = Af * breederFrac;
    const births = breeders * litter * fertMult;
    const pupsF = births * birthFracFemale;
    const pupsM = births * (1.0 - birthFracFemale);

    // Transitions
    let nextJf = pupsF;
    let nextJm = pupsM;
    let nextSf = Jf * survJ;
    let nextSm = Jm * survJ;
    let nextAf = Sf * survS + Af * survA;
    let nextAm = Sm * survS + Am * survA;

    // Adult aging
    nextAf = Math.max(0, nextAf - Af * agingA);
    nextAm = Math.max(0, nextAm - Am * agingA);

    // Owl predation, proportional, scaled by density
    if (owlsOn){
      const owlsEff = owlsPer100Acres * (acres/100.0);
      const perOwlPerWeek = 2.5;
      const owlRemoval = owlsEff * perOwlPerWeek * 52.0 * Math.max(0, Math.min(1, density));
      const afterTot = nextJf + nextJm + nextSf + nextSm + nextAf + nextAm;
      if (afterTot > 0 && owlRemoval > 0){
        const frac = Math.min(1.0, owlRemoval / afterTot);
        const k = (1.0 - frac);
        nextJf*=k; nextJm*=k; nextSf*=k; nextSm*=k; nextAf*=k; nextAm*=k;
      }
    }

    return [[nextJf,nextJm],[nextSf,nextSm],[nextAf,nextAm]];
  }

  function sumAll(P){ return P[0][0]+P[0][1]+P[1][0]+P[1][1]+P[2][0]+P[2][1]; }

  function initialize(acres, level){
    const totalInit = basePer10(level) * (acres/10.0);
    const Af = totalInit * birthFracFemale;
    const Am = totalInit * (1.0 - birthFracFemale);
    const zero = 0.0;
    const start = [[zero,zero],[zero,zero],[Af,Am]];
    return { natural: cloneP(start), treated: cloneP(start) };
  }
  function cloneP(P){ return [[P[0][0],P[0][1]],[P[1][0],P[1][1]],[P[2][0],P[2][1]]]; }

  function computeDamages(acres, level, isTreated){
    const levelName = isTreated ? "—" : severityName(level);
    const rate = isTreated ? lossAfterTreat : lossRate(level);

    const baseRevenue = acres * yieldLbPerAcre * pricePerLb;
    const lossOfCrop = baseRevenue * rate;

    const sm = isTreated ? 1.0 : sevMult(level);
    let drip  = dripPerAcre_base    * sm * acres;
    let cropD = cropDmgPerAcre_base * sm * acres;
    let other = otherPerAcre_base   * sm * acres;

    if (isTreated){
      drip *= maintMultiplierAfterTreat;
      cropD*= maintMultiplierAfterTreat;
      other*= maintMultiplierAfterTreat;
    }
    return { levelName, rate, lossOfCrop, drip, cropD, other,
             total: (lossOfCrop + drip + cropD + other) };
  }

  // One-year projection returning per-acre populations + damages
  function project({ acres, level, owlsOn }){
    const { natural: N0, treated: T0 } = initialize(acres, level);

    // Year 1
    const N1 = annualStep(N0, acres, owlsOn);
    let T1 = annualStep(T0, acres, owlsOn);
    // Apply annual treatment survival to treated only
    for (let a=0;a<3;a++){ for(let s=0;s<2;s++){ T1[a][s] *= surviveAnnual; } }

    const natPerAcre = Math.round(sumAll(N1)/acres);
    const trtPerAcre = Math.round(sumAll(T1)/acres);

    const dN = computeDamages(acres, level, false);
    const dT = computeDamages(acres, level, true);

    return {
      natPerAcre, trtPerAcre,
      dN, dT
    };
  }

  return { project };
})();

/* ------------------------------ UI Wiring ------------------------------ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const acreRange = $("#acres");
const acreBubble = $("#acreBubble");
const compareChk = $("#compare");
const owlsChk = $("#owls");

const infButtons = $$(".infbtn");

const natTotal = $("#natTotal");
const trtTotal = $("#trtTotal");
const natBreak = $("#natBreak");
const trtBreak = $("#trtBreak");
const natPerAcre = $("#natPerAcre");
const trtPerAcre = $("#trtPerAcre");
const treatedCard = $("#treatedCard");

function fmtMoney(n){
  // currency with commas, no decimals
  return "$" + Math.round(n).toLocaleString("en-US");
}
function setAcreBubble(){
  const min = +acreRange.min, max = +acreRange.max, val = +acreRange.value;
  acreBubble.textContent = `${val} acres`;
  const pct = (val - min) / (max - min);
  const thumbPx = 22; // matches CSS
  const pad = 0; // slider padding
  const w = acreRange.clientWidth;
  const x = pad + pct * (w - 0);
  acreBubble.style.left = `${x}px`;
}

function activeLevel(){
  const btn = infButtons.find(b => b.classList.contains("active"));
  return parseInt(btn.dataset.level,10);
}

function render(){
  const acres = +acreRange.value;
  const level = activeLevel(); // 1/2/3 ; “Small/Medium/Large” internally
  const owlsOn = owlsChk.checked;

  const { natPerAcre: npa, trtPerAcre: tpa, dN, dT } = Model.project({ acres, level, owlsOn });

  // Natural
  natTotal.textContent = fmtMoney(dN.total);
  natBreak.innerHTML = `
    <tr><td>Loss of crop</td><td>${fmtMoney(dN.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${fmtMoney(dN.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${fmtMoney(dN.cropD)}</td></tr>
    <tr><td>Other O&amp;M</td><td>${fmtMoney(dN.other)}</td></tr>
    <tr><td>Total</td><td>${fmtMoney(dN.total)}</td></tr>
  `;
  natPerAcre.textContent = `${npa}`;

  // Treated (if compare)
  if (compareChk.checked){
    treatedCard.style.display = "";
    trtTotal.textContent = fmtMoney(dT.total);
    trtBreak.innerHTML = `
      <tr><td>Loss of crop</td><td>${fmtMoney(dT.lossOfCrop)}</td></tr>
      <tr><td>Drip/irrigation</td><td>${fmtMoney(dT.drip)}</td></tr>
      <tr><td>Crop damage</td><td>${fmtMoney(dT.cropD)}</td></tr>
      <tr><td>Other O&amp;M</td><td>${fmtMoney(dT.other)}</td></tr>
      <tr><td>Total</td><td>${fmtMoney(dT.total)}</td></tr>
    `;
    trtPerAcre.textContent = `${tpa}`;
  } else {
    treatedCard.style.display = "none";
  }
}

// Events
infButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    infButtons.forEach(b=>{ b.classList.toggle("active", b===btn); b.setAttribute("aria-selected", b===btn ? "true":"false"); });
    render();
  });
});

acreRange.addEventListener("input", ()=>{
  setAcreBubble();
  render();
});

compareChk.addEventListener("change", render);
owlsChk.addEventListener("change", render);

// Initial
window.addEventListener("load", ()=>{
  setAcreBubble();
  render();
  // Reposition bubble on resize
  window.addEventListener("resize", setAcreBubble);
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smokin’ Burrow – Rodent Impact Estimator (1-Year)</title>
<style>
  :root{
    --yellow:#f4cf2f; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --bg:#f8fafc; --card:#ffffff; --radius:20px; --shadow:0 18px 40px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  .wrap{
    max-width:1200px; margin:48px auto; padding:0 20px;
    display:grid; grid-template-columns:440px 1fr; gap:28px;
  }
  .panel{ border-radius:var(--radius); box-shadow:var(--shadow); }
  .left{ background:var(--yellow); padding:32px 26px; display:flex; flex-direction:column; gap:26px; }
  .right{ background:var(--card); padding:28px 26px; }

  .lead{ display:flex; flex-direction:column; gap:8px; }
  .lead h1{ margin:0; font-size:28px; line-height:1.15; letter-spacing:-0.01em; }
  .lead .sub{ font-size:14px; opacity:.85; }

  .group{ display:flex; flex-direction:column; gap:12px; }
  .label{ font-weight:800; font-size:13px; letter-spacing:.04em; text-transform:uppercase; }

  /* Segmented full-width tiles */
  .segmented{
    display:grid; grid-template-columns: repeat(3, 1fr);
    width:100%; padding:6px; gap:0;
    border-radius:14px; background:rgba(255,255,255,.50);
    border:2px solid rgba(0,0,0,.06);
  }
  .segmented button{
    appearance:none; border:0; cursor:pointer; width:100%; padding:14px 0;
    font-weight:800; font-size:15px; color:#0f172a; background:transparent;
    border-radius:10px; border:2px solid transparent;
    transition:background .12s ease, transform .06s ease, box-shadow .12s ease, opacity .12s ease;
  }
  .segmented button:hover{ background:rgba(255,255,255,.35); }
  .segmented button:active{ transform:translateY(1px); }
  .segmented button.active{
    background:#ffffff; border-color:rgba(0,0,0,.06);
    box-shadow:0 8px 20px rgba(0,0,0,.10);
  }
  .segmented button.inactive{
    opacity:.55;
  }

  /* Slider + bubble */
  .slider-wrap{ position:relative; padding-top:14px; }
  input[type="range"]{
    -webkit-appearance:none; width:100%; height:8px; border-radius:999px;
    background:#fff; outline:none; border:2px solid rgba(0,0,0,.07);
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; width:26px; height:26px; border-radius:50%;
    background:#fff; border:2px solid rgba(0,0,0,.12);
    box-shadow:0 6px 18px rgba(0,0,0,.12); cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{
    width:26px; height:26px; border:none; border-radius:50%;
    background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.12); cursor:pointer;
  }
  .bubble{
    position:absolute; top:-2px; transform:translate(-50%,-100%);
    background:#111827; color:#fff; padding:6px 10px; font-size:12px; border-radius:10px;
    box-shadow:0 10px 22px rgba(0,0,0,.14); white-space:nowrap;
  }
  .bubble:after{
    content:""; position:absolute; left:50%; bottom:-6px; transform:translateX(-50%);
    border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #111827;
  }

  /* Switch */
  .switch{ display:flex; align-items:center; gap:12px; font-weight:700; }
  .switch input{ display:none; }
  .toggle{ width:54px; height:30px; border-radius:999px; background:rgba(0,0,0,.25); position:relative; cursor:pointer; }
  .toggle:after{ content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); transition:transform .18s ease; }
  .switch input:checked + .toggle{ background:#16a34a; }
  .switch input:checked + .toggle:after{ transform:translateX(24px); }

  /* Right header */
  .headerline{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:10px; }
  .title{ font-size:16px; font-weight:800; letter-spacing:.06em; text-transform:uppercase; color:#374151; }

  /* Cards & table */
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
  .card{ border:1px solid var(--border); border-radius:16px; padding:18px; }
  .card h3{ margin:0 0 8px; font-size:13px; letter-spacing:.06em; color:#6b7280; text-transform:uppercase; }

  .metric{ display:flex; align-items:baseline; gap:10px; margin:12px 0 8px; }
  .num{ font-size:40px; font-weight:900; letter-spacing:-0.02em; }
  .badge{ padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; font-weight:800; color:#374151; }

  .tbl{ width:100%; border-collapse:collapse; font-size:14px; }
  .tbl td{ padding:10px 0; border-bottom:1px dashed var(--border); }
  .tbl td:last-child{ text-align:right; font-variant-numeric:tabular-nums; }
  .tbl tr:last-child td{ border-bottom:none; font-weight:800; }

  .foot{ margin-top:10px; color:#6b7280; font-size:12px; }
  .owlNote{ margin-top:6px; color:#6b7280; font-size:12px; }

  .footSmall{ margin-top:6px; color:#6b7280; font-size:12px; }

  @media (max-width:980px){
    .wrap{ grid-template-columns:1fr; }
    .grid{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT / CONTROLS -->
    <section class="panel left" aria-label="Controls">
      <div class="lead">
        <h1>See how much rodents cost you</h1>
        <div class="sub">Toggle rodent types, set severity & acres. Results update instantly.</div>
      </div>

      <!-- Rodent Types (multi-select) -->
      <div class="group">
        <div class="label">Rodent Types</div>
        <div class="segmented" role="group" aria-label="Rodent Types">
          <button type="button" class="speciesbtn active" data-id="gopher" aria-pressed="true">Gophers</button>
          <button type="button" class="speciesbtn inactive" data-id="rat" aria-pressed="false">Rats</button>
          <button type="button" class="speciesbtn inactive" data-id="squirrel" aria-pressed="false">Ground&nbsp;Squirrels</button>
        </div>
      </div>

      <!-- Infestation Level -->
      <div class="group" id="infestationGroup">
        <div class="label">Infestation Level</div>
        <div class="segmented" role="tablist" aria-label="Infestation Level">
          <button type="button" class="infbtn" data-level="1" role="tab" aria-selected="false">Mild</button>
          <button type="button" class="infbtn active" data-level="2" role="tab" aria-selected="true">Medium</button>
          <button type="button" class="infbtn" data-level="3" role="tab" aria-selected="false">Severe</button>
        </div>
      </div>

      <!-- Acres slider -->
      <div class="group">
        <div class="label">Acres</div>
        <div class="slider-wrap">
          <div class="bubble" id="acreBubble">40 acres</div>
          <input id="acres" type="range" min="10" max="80" step="1" value="40" aria-label="Acres" />
        </div>
      </div>

      <!-- Owl Boxes -->
      <div class="group">
        <label class="switch">
          <input id="owls" type="checkbox" aria-label="Owl Boxes" />
          <span class="toggle" aria-hidden="true"></span>
          <span>Owl Boxes</span>
        </label>
      </div>
    </section>

    <!-- RIGHT / RESULTS -->
    <section class="panel right" aria-live="polite" aria-atomic="true">
      <div class="headerline">
        <div class="title">1-Year Impact (Almonds)</div>
      </div>

      <div class="grid">
        <!-- Natural -->
        <div class="card" id="naturalCard">
          <h3>Natural</h3>
          <div class="metric">
            <div class="num" id="natTotal">$—</div>
            <span class="badge">Total Damage (1 year)</span>
          </div>
          <table class="tbl" aria-label="Natural damage breakdown">
            <tbody id="natBreak"></tbody>
          </table>
          <div class="foot">
            Population after 1 year: <strong id="natPerAcre">—</strong> per acre
          </div>
          <div class="footSmall" id="natPerSpecies">—</div>
          <div class="owlNote" id="natOwl">Owl effect: —/acre · Removal est.: —/yr · Damage change: —</div>
        </div>

        <!-- Treated -->
        <div class="card" id="treatedCard">
          <h3>Treated</h3>
          <div class="metric">
            <div class="num" id="trtTotal">$—</div>
            <span class="badge">Total Damage (1 year)</span>
          </div>
          <table class="tbl" aria-label="Treated damage breakdown">
            <tbody id="trtBreak"></tbody>
          </table>
          <div class="foot">
            Population after 1 year: <strong id="trtPerAcre">—</strong> per acre
          </div>
          <div class="footSmall" id="trtPerSpecies">—</div>
          <div class="owlNote" id="trtOwl">Owl effect: —/acre · Removal est.: —/yr · Damage change: —</div>
        </div>
      </div>
      <div class="owlNote" style="margin-top:10px;">
        Note: Owl Boxes reduce damages in proportion to the population reduction they cause (yield lightly, non-yield more). Species use gopher constants by default — update in <code>SPECIES</code> below when you’re ready.
      </div>
    </section>
  </div>

<script>
/* ------------------------------ Species-configurable deterministic model ------------------------------ */
/* If you have species-specific constants from your other module, paste them into SPECIES. */
const SPECIES = {
  gopher: {
    name: "Gophers",
    owlEffectFactor: 1.0, // scale owl predation power for this species
    // Biology
    K_per_acre: 80.0,
    litterMean: 6.0,
    birthFracFemale: 0.70,
    breederFrac: 0.80,
    fertSlope: 3.5,
    survJ: 0.45, survS: 0.65, survA: 0.82,
    agingA: 0.08,
    // Initialization per severity (per 10 acres)
    basePer10: {1:20.0, 2:40.0, 3:70.0},
    // Economics (almonds)
    pricePerLb: 2.50, yieldLbPerAcre: 2500.0,
    lossRate: {1:0.02, 2:0.04, 3:0.06}, lossAfterTreat: 0.01,
    dripPerAcre: 60.0, cropDmgPerAcre: 40.0, otherPerAcre: 70.0,
    sevMult: {1:0.8, 2:1.0, 3:1.2},
    maintMultiplierAfterTreat: 0.20,
  },
  rat: {
    name: "Rats",
    owlEffectFactor: 1.0, // TODO: adjust if your prior model differed
    // For now, copy gopher constants; replace with your rat constants when available
    K_per_acre: 80.0, litterMean: 6.0, birthFracFemale: 0.70, breederFrac: 0.80, fertSlope: 3.5,
    survJ: 0.45, survS: 0.65, survA: 0.82, agingA: 0.08,
    basePer10: {1:20.0, 2:40.0, 3:70.0},
    pricePerLb: 2.50, yieldLbPerAcre: 2500.0,
    lossRate: {1:0.02, 2:0.04, 3:0.06}, lossAfterTreat: 0.01,
    dripPerAcre: 60.0, cropDmgPerAcre: 40.0, otherPerAcre: 70.0,
    sevMult: {1:0.8, 2:1.0, 3:1.2},
    maintMultiplierAfterTreat: 0.20,
  },
  squirrel: {
    name: "Ground Squirrels",
    owlEffectFactor: 1.0, // TODO: adjust if your prior model differed
    // For now, copy gopher constants; replace with your squirrel constants when available
    K_per_acre: 80.0, litterMean: 6.0, birthFracFemale: 0.70, breederFrac: 0.80, fertSlope: 3.5,
    survJ: 0.45, survS: 0.65, survA: 0.82, agingA: 0.08,
    basePer10: {1:20.0, 2:40.0, 3:70.0},
    pricePerLb: 2.50, yieldLbPerAcre: 2500.0,
    lossRate: {1:0.02, 2:0.04, 3:0.06}, lossAfterTreat: 0.01,
    dripPerAcre: 60.0, cropDmgPerAcre: 40.0, otherPerAcre: 70.0,
    sevMult: {1:0.8, 2:1.0, 3:1.2},
    maintMultiplierAfterTreat: 0.20,
  }
};

// Treatment: CO₂ (25% kill/pass, 6 passes/year)
const PASSES_PER_YEAR = 6, KILL_RATE_PER_PASS = 0.25;
const SURVIVE_ANNUAL = Math.pow(1 - KILL_RATE_PER_PASS, PASSES_PER_YEAR); // (0.75)^6

// Owl predation base
const OWLS_PER_100_ACRES = 1.9;
const PREDATION_PER_OWL_PER_WEEK = 2.5; // midpoint of 1–4

// Owl → damage discount tuning (same as previous version)
const GAMMA = 3.0;     // amplify population reduction into visible $ effect
const BETA_YIELD = 0.30;
const BETA_NON   = 0.60;

function cloneP(P){ return [[P[0][0],P[0][1]],[P[1][0],P[1][1]],[P[2][0],P[2][1]]]; }
const sumAll = P => P[0][0]+P[0][1]+P[1][0]+P[1][1]+P[2][0]+P[2][1];

function initializeSpecies(spec, acres, level){
  const totalInit = spec.basePer10[level] * (acres/10.0);
  const Af = totalInit * spec.birthFracFemale;
  const Am = totalInit * (1.0 - spec.birthFracFemale);
  return [[0,0],[0,0],[Af,Am]]; // [J][S][A] x [F,M]
}

function annualStepSpecies(spec, P, acres, owlsOn){
  let [Jf,Jm,Sf,Sm,Af,Am] = [P[0][0],P[0][1],P[1][0],P[1][1],P[2][0],P[2][1]];
  const K_total = spec.K_per_acre * acres;
  const total   = Jf+Jm+Sf+Sm+Af+Am;
  const density = K_total>0 ? total / K_total : 0.0;

  const fertMult = 1 / (1 + Math.exp(spec.fertSlope * (density - 1.0)));

  // reproduction
  const litter = spec.litterMean;
  const breeders = Af * spec.breederFrac;
  const births = breeders * litter * fertMult;
  const pupsF  = births * spec.birthFracFemale;
  const pupsM  = births * (1 - spec.birthFracFemale);

  // transitions
  let nextJf = pupsF;
  let nextJm = pupsM;
  let nextSf = Jf * spec.survJ;
  let nextSm = Jm * spec.survJ;
  let nextAf = Sf * spec.survS + Af * spec.survA;
  let nextAm = Sm * spec.survS + Am * spec.survA;

  // aging
  nextAf = Math.max(0, nextAf - Af * spec.agingA);
  nextAm = Math.max(0, nextAm - Am * spec.agingA);

  let removed = 0;
  if (owlsOn){
    const owlsEff = OWLS_PER_100_ACRES * (acres/100.0);
    const owlRemoval = spec.owlEffectFactor * owlsEff * PREDATION_PER_OWL_PER_WEEK * 52.0 * Math.max(0, Math.min(1, density));
    const afterTot = nextJf + nextJm + nextSf + nextSm + nextAf + nextAm;
    if (afterTot > 0 && owlRemoval > 0){
      const frac = Math.min(1.0, owlRemoval / afterTot);
      const k = 1 - frac;
      removed = afterTot - afterTot * k;
      nextJf*=k; nextJm*=k; nextSf*=k; nextSm*=k; nextAf*=k; nextAm*=k;
    }
  }
  return { P:[[nextJf,nextJm],[nextSf,nextSm],[nextAf,nextAm]], removed };
}

function damagesForSpecies(spec, acres, level, isTreated, factors){
  const fYield = factors ? factors.yieldFactor : 1.0;
  const fNon   = factors ? factors.nonYieldFactor : 1.0;

  const baseRev = acres * spec.yieldLbPerAcre * spec.pricePerLb;
  const baseRate = isTreated ? spec.lossAfterTreat : spec.lossRate[level];
  const lossRateAdj = baseRate * fYield;
  const lossOfCrop  = baseRev * lossRateAdj;

  const baseMult = isTreated ? 1.0 : spec.sevMult[level];
  let drip  = spec.dripPerAcre    * baseMult * acres;
  let cropD = spec.cropDmgPerAcre * baseMult * acres;
  let other = spec.otherPerAcre   * baseMult * acres;

  if (isTreated){
    drip  *= spec.maintMultiplierAfterTreat;
    cropD *= spec.maintMultiplierAfterTreat;
    other *= spec.maintMultiplierAfterTreat;
  }

  drip  *= fNon;
  cropD *= fNon;
  other *= fNon;

  return { lossOfCrop, drip, cropD, other, total: lossOfCrop + drip + cropD + other };
}

function projectAll({ acres, level, owlsOn, activeIds }){
  // Per-species baseline (owls OFF) & owl (ON)
  const perSpecies = {};
  let agg = {
    natPA_off:0, trtPA_off:0, natPA_on:0, trtPA_on:0,
    natRemovedSum:0, trtRemovedSum:0,
    dN_base:{lossOfCrop:0,drip:0,cropD:0,other:0,total:0},
    dT_base:{lossOfCrop:0,drip:0,cropD:0,other:0,total:0},
    dN_owl: {lossOfCrop:0,drip:0,cropD:0,other:0,total:0},
    dT_owl: {lossOfCrop:0,drip:0,cropD:0,other:0,total:0},
  };

  activeIds.forEach(id=>{
    const spec = SPECIES[id];

    // init
    const N0 = initializeSpecies(spec, acres, level);
    const T0 = cloneP(N0);

    // OFF
    const N_off = annualStepSpecies(spec, N0, acres, false);
    const T_off = annualStepSpecies(spec, T0, acres, false);
    const T_off_after = cloneP(T_off.P);
    for(let a=0;a<3;a++) for(let s=0;s<2;s++) T_off_after[a][s] *= SURVIVE_ANNUAL;

    const natPA_off = sumAll(N_off.P)/acres;
    const trtPA_off = sumAll(T_off_after)/acres;

    const dN_base = damagesForSpecies(spec, acres, level, false, null);
    const dT_base = damagesForSpecies(spec, acres, level, true , null);

    // ON
    const N_on = annualStepSpecies(spec, N0, acres, true);
    const T_on = annualStepSpecies(spec, T0, acres, true);
    const T_on_after = cloneP(T_on.P);
    for(let a=0;a<3;a++) for(let s=0;s<2;s++) T_on_after[a][s] *= SURVIVE_ANNUAL;

    const natPA_on = sumAll(N_on.P)/acres;
    const trtPA_on = sumAll(T_on_after)/acres;

    const eps = 1e-9;
    const rN = Math.max(0, (natPA_off - natPA_on)/Math.max(eps, natPA_off));
    const rT = Math.max(0, (trtPA_off - trtPA_on)/Math.max(eps, trtPA_off));
    const rHatN = Math.min(1, GAMMA * rN);
    const rHatT = Math.min(1, GAMMA * rT);

    const factorsN = { yieldFactor: 1 - BETA_YIELD*rHatN, nonYieldFactor: 1 - BETA_NON*rHatN };
    const factorsT = { yieldFactor: 1 - BETA_YIELD*rHatT, nonYieldFactor: 1 - BETA_NON*rHatT };

    const dN_owl = damagesForSpecies(spec, acres, level, false, factorsN);
    const dT_owl = damagesForSpecies(spec, acres, level, true , factorsT);

    // aggregate
    agg.natPA_off += natPA_off;
    agg.trtPA_off += trtPA_off;
    agg.natPA_on  += natPA_on;
    agg.trtPA_on  += trtPA_on;

    agg.natRemovedSum += Math.round(N_on.removed);
    agg.trtRemovedSum += Math.round(T_on.removed);

    for(const k of ["lossOfCrop","drip","cropD","other","total"]){
      agg.dN_base[k]+=dN_base[k];
      agg.dT_base[k]+=dT_base[k];
      agg.dN_owl[k] +=dN_owl[k];
      agg.dT_owl[k] +=dT_owl[k];
    }

    perSpecies[id] = {
      name: spec.name,
      natPA_off, natPA_on, trtPA_off, trtPA_on
    };
  });

  // choose display based on toggle
  const natPerAcre = owlsOn ? agg.natPA_on : agg.natPA_off;
  const trtPerAcre = owlsOn ? agg.trtPA_on : agg.trtPA_off;

  const dN = owlsOn ? agg.dN_owl : agg.dN_base;
  const dT = owlsOn ? agg.dT_owl : agg.dT_base;

  const natDelta = owlsOn ? (agg.dN_base.total - agg.dN_owl.total) : 0;
  const trtDelta = owlsOn ? (agg.dT_base.total - agg.dT_owl.total) : 0;
  const natDeltaPct = owlsOn && agg.dN_base.total>0 ? (natDelta/agg.dN_base.total) : 0;
  const trtDeltaPct = owlsOn && agg.dT_base.total>0 ? (trtDelta/agg.dT_base.total) : 0;

  const owlPerAcreDropN = owlsOn ? (agg.natPA_off - agg.natPA_on) : 0;
  const owlPerAcreDropT = owlsOn ? (agg.trtPA_off - agg.trtPA_on) : 0;

  return {
    natPerAcre, trtPerAcre, dN, dT,
    natRemoved: owlsOn ? agg.natRemovedSum : 0,
    trtRemoved: owlsOn ? agg.trtRemovedSum : 0,
    owlPerAcreDropN, owlPerAcreDropT,
    natDelta, trtDelta, natDeltaPct, trtDeltaPct,
    perSpecies
  };
}

/* ------------------------------ UI wiring ------------------------------ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const acreRange = $("#acres");
const acreBubble = $("#acreBubble");
const owlsChk = $("#owls");
const speciesBtns = $$(".speciesbtn");
const infButtons = $$(".infbtn");

const natTotalEl = $("#natTotal");
const trtTotalEl = $("#trtTotal");
const natBreakEl = $("#natBreak");
const trtBreakEl = $("#trtBreak");
const natPerAcreEl = $("#natPerAcre");
const trtPerAcreEl = $("#trtPerAcre");
const natOwlEl = $("#natOwl");
const trtOwlEl = $("#trtOwl");
const natPerSpeciesEl = $("#natPerSpecies");
const trtPerSpeciesEl = $("#trtPerSpecies");

// state: active species
function getActiveSpecies(){
  const ids = speciesBtns.filter(b => b.classList.contains("active")).map(b => b.dataset.id);
  return ids.length ? ids : ["gopher"]; // guard: ensure at least gopher
}

function fmtMoney(n){ return "$" + Math.round(n).toLocaleString("en-US"); }
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }

function setAcreBubble(){
  const min = +acreRange.min, max = +acreRange.max, val = +acreRange.value;
  acreBubble.textContent = `${val} acres`;
  const pct = (val - min) / (max - min);
  const w = acreRange.clientWidth;
  acreBubble.style.left = `${pct * w}px`;
}

function activeLevel(){
  const btn = infButtons.find(b => b.classList.contains("active"));
  return parseInt(btn.dataset.level,10);
}

function perSpeciesLine(perSpecies, useOwls, natural){
  // natural? pick natPA_*; else trtPA_*
  const key = natural ? (useOwls ? "natPA_on" : "natPA_off")
                      : (useOwls ? "trtPA_on" : "trtPA_off");
  const parts = Object.values(perSpecies).map(sp => `${sp.name.split(" ")[0]} ${sp[key].toFixed(1)}/ac`);
  return parts.length ? `By species: ${parts.join(" • ")}` : "—";
}

function render(){
  const acres = +acreRange.value;
  const level = activeLevel();
  const owlsOn = owlsChk.checked;
  const activeIds = getActiveSpecies();

  const {
    natPerAcre, trtPerAcre, dN, dT,
    natRemoved, trtRemoved,
    owlPerAcreDropN, owlPerAcreDropT,
    natDelta, trtDelta, natDeltaPct, trtDeltaPct,
    perSpecies
  } = projectAll({ acres, level, owlsOn, activeIds });

  // Natural
  natTotalEl.textContent = fmtMoney(dN.total);
  natBreakEl.innerHTML = `
    <tr><td>Loss of crop</td><td>${fmtMoney(dN.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${fmtMoney(dN.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${fmtMoney(dN.cropD)}</td></tr>
    <tr><td>Other O&amp;M</td><td>${fmtMoney(dN.other)}</td></tr>
    <tr><td>Total</td><td>${fmtMoney(dN.total)}</td></tr>
  `;
  natPerAcreEl.textContent = natPerAcre.toFixed(1);
  natPerSpeciesEl.textContent = perSpeciesLine(perSpecies, owlsOn, /*natural=*/true);
  natOwlEl.textContent = owlsOn
    ? `Owl effect: −${owlPerAcreDropN.toFixed(1)}/acre · Removal est.: ${Math.round(natRemoved).toLocaleString()} / yr · Damage change: −${fmtMoney(natDelta)} (−${fmtPct(natDeltaPct)})`
    : `Owl effect: 0.0/acre · Removal est.: 0 / yr · Damage change: $0 (0%)`;

  // Treated
  trtTotalEl.textContent = fmtMoney(dT.total);
  trtBreakEl.innerHTML = `
    <tr><td>Loss of crop</td><td>${fmtMoney(dT.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${fmtMoney(dT.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${fmtMoney(dT.cropD)}</td></tr>
    <tr><td>Other O&amp;M</td><td>${fmtMoney(dT.other)}</td></tr>
    <tr><td>Total</td><td>${fmtMoney(dT.total)}</td></tr>
  `;
  trtPerAcreEl.textContent = trtPerAcre.toFixed(1);
  trtPerSpeciesEl.textContent = perSpeciesLine(perSpecies, owlsOn, /*natural=*/false);
  trtOwlEl.textContent = owlsOn
    ? `Owl effect: −${owlPerAcreDropT.toFixed(1)}/acre · Removal est.: ${Math.round(trtRemoved).toLocaleString()} / yr · Damage change: −${fmtMoney(trtDelta)} (−${fmtPct(trtDeltaPct)})`
    : `Owl effect: 0.0/acre · Removal est.: 0 / yr · Damage change: $0 (0%)`;
}

/* events */
$$(".infbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".infbtn").forEach(b=>{
      const on = (b===btn);
      b.classList.toggle("active", on);
      b.setAttribute("aria-selected", on ? "true" : "false");
    });
    render();
  });
});

speciesBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const isActive = btn.classList.contains("active");
    // toggle state
    btn.classList.toggle("active", !isActive);
    btn.classList.toggle("inactive", isActive);
    btn.setAttribute("aria-pressed", (!isActive).toString());
    // guard: ensure at least one species is active
    const anyOn = speciesBtns.some(b=>b.classList.contains("active"));
    if (!anyOn){
      const g = speciesBtns.find(b=>b.dataset.id==="gopher");
      g.classList.add("active"); g.classList.remove("inactive"); g.setAttribute("aria-pressed","true");
    }
    render();
  });
});

acreRange.addEventListener("input", ()=>{ setAcreBubble(); render(); });
$("#owls").addEventListener("change", render);

// initial
window.addEventListener("load", ()=>{
  setAcreBubble();
  render();
  window.addEventListener("resize", setAcreBubble);
});
</script>
</body>
</html>
